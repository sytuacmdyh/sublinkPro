# Zeabur è‡ªåŠ¨éƒ¨ç½² Workflow
# å½“ Build and Release Multi-Platform å®Œæˆ Docker é•œåƒæ¨é€åï¼Œè‡ªåŠ¨è§¦å‘ Zeabur éƒ¨ç½²
# ä½¿ç”¨ Zeabur å®˜æ–¹ CLI å·¥å…·: https://github.com/zeabur/cli
name: Deploy to Zeabur

on:
  workflow_run:
    workflows: ["Build and Release Multi-Platform"]
    types:
      - completed

# æ˜¾å¼å£°æ˜æƒé™ï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
# æ­¤å·¥ä½œæµä»…éœ€è¦è¯»å–æƒé™ï¼Œä¸éœ€è¦å†™å…¥ä»“åº“ä»»ä½•å†…å®¹
permissions:
  contents: read

jobs:
  deploy:
    # ä»…åœ¨ä¸Šæ¸¸ workflow æˆåŠŸå®Œæˆæ—¶è¿è¡Œ
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wait for Docker image availability
        run: |
          echo "ç­‰å¾… Docker é•œåƒåœ¨ Docker Hub ä¸Šå¯ç”¨..."
          sleep 30

      - name: Deploy to Zeabur using CLI
        run: |
          echo "ä½¿ç”¨ Zeabur CLI è§¦å‘é‡æ–°éƒ¨ç½²..."
          
          # éœ€è¦åœ¨ GitHub Secrets ä¸­é…ç½®:
          # - ZEABUR_TOKEN: åœ¨ https://dash.zeabur.com/account/developer è·å–
          # - ZEABUR_PROJECT_ID: é¡¹ç›® IDï¼ˆä» Zeabur æ§åˆ¶å° URL è·å–ï¼Œæ ¼å¼: /projects/<project-id>/...ï¼‰
          # - ZEABUR_ENV_ID: ç¯å¢ƒ IDï¼ˆä» Zeabur æ§åˆ¶å° URL è·å–ï¼‰
          # - ZEABUR_SERVICE_ID: æœåŠ¡ IDï¼ˆä» Zeabur æ§åˆ¶å° URL è·å–ï¼Œæ ¼å¼: /projects/<project-id>/services/<service-id>ï¼‰
          
          # ä½¿ç”¨ token ç™»å½•ï¼ˆéäº¤äº’æ¨¡å¼ï¼‰
          npx zeabur auth login --token "${{ secrets.ZEABUR_TOKEN }}"
          
          # è®¾ç½® project contextï¼ˆå¿…é¡»ï¼‰
          npx zeabur context set project --id "${{ secrets.ZEABUR_PROJECT_ID }}"
          
          # é‡å¯æœåŠ¡ä»¥è§¦å‘é‡æ–°éƒ¨ç½²
          npx zeabur service restart -i=false \
            --env-id "${{ secrets.ZEABUR_ENV_ID }}" \
            --id "${{ secrets.ZEABUR_SERVICE_ID }}"
          
          echo "âœ… Zeabur éƒ¨ç½²è§¦å‘æˆåŠŸï¼"

      - name: Deployment Summary
        run: |
          echo "## ğŸš€ Zeabur éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘ Workflow**: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
