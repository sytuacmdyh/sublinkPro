# 测速系统

SublinkPro 提供专业级的节点测速功能，采用科学的测试方法确保结果准确可靠。

---

## 🔬 技术特点

| 特点 | 说明 |
|:---|:---|
| **双阶段分离测试** | 延迟测试与下载速度测试分开进行，各自使用最适合的测试URL和方法 |
| **智能延迟测量** | 支持 UnifiedDelay 模式，可选择包含或排除握手时间（系统自动发送两次请求取第二次结果） |
| **独立并发设置** | 延迟测试和速度测试可分别配置不同的并发数，平衡效率与精度 |
| **状态自动标记** | 测速完成后自动根据结果更新节点的延迟状态和速度状态 |
| **实时进度展示** | 测速过程中实时显示进度和状态，支持任务面板查看 |
| **流量统计** | 每个节点测速完成后记录消耗流量，任务完成时汇总显示 |

---

## 📊 测速状态分类

| 颜色 | 延迟阈值 | 速度阈值 |
|:---|:---|:---|
| 🟢 绿色 | < 200ms | >= 5 MB/s |
| 🟡 黄色 | 200-500ms | 1-5 MB/s |
| 🔴 红色 | >= 500ms 或超时/失败 | < 1 MB/s 或失败 |
| ⚪ 灰色 | 未测试 | 未测试 |

---

## 🔧 测速原理与流量计算

> [!IMPORTANT]
> **核心原理**：测速采用「限时下载」方式，即在设定的超时时间内尽可能多地下载数据，然后根据实际下载的字节数和耗时计算速度。

**速度计算公式**：
```
速度 (MB/s) = 实际下载字节数 ÷ 1024 ÷ 1024 ÷ 实际耗时(秒)
```

### 常见疑问

| 现象 | 原因 |
|:---|:---|
| 设置 5MB 测速文件，但实际下载不到 5MB | 节点速度慢，在超时时间内未下载完 |
| 有的节点下载 500KB，有的下载 5MB | 速度快的节点在超时前下载完成，慢的节点下载不完 |
| 流量消耗显示几百KB | 节点速度约为 100KB/s × 超时时间(秒) |

### 示例（假设超时时间为 5 秒）

| 节点速度 | 实际下载量 | 计算结果 |
|:---|:---|:---|
| 10 MB/s | 5 MB（提前完成） | 速度 ≈ 10 MB/s |
| 1 MB/s | 5 MB | 速度 = 1 MB/s |
| 0.2 MB/s | 1 MB | 速度 = 0.2 MB/s |
| 0.1 MB/s | 500 KB | 速度 = 0.1 MB/s |

---

## ⚙️ 参数配置建议

| 参数 | 说明 | 建议值 |
|:---|:---|:---|
| **测速超时时间** | 每个节点测速的最大时长 | 5-10秒（平衡速度与准确性） |
| **测速文件 URL** | 用于下载测速的文件地址 | 建议 ≥ 超时时间 × 预期最大速度 |
| **延迟测试 URL** | 用于延迟测试的地址 | 建议使用 HTTP 204 或小文件，如 Cloudflare 的 generate_204 |
| **延迟测试并发** | 同时进行延迟测试的节点数 | 10-50（可适当调高） |
| **速度测试并发** | 同时进行速度测试的节点数 | 1-3（避免带宽竞争） |

> [!TIP]
> **测速文件大小建议**：如果超时时间为 5 秒，预期最快节点为 20 MB/s，则测速文件应 ≥ 100MB。推荐使用 Cloudflare 的测速 URL：`https://speed.cloudflare.com/__down?bytes=100000000`（100MB）
> 
> ⚠️ **注意**：文件越大超时时间越大可能消耗流量越多

> [!WARNING]
> **流量消耗提示**：每次测速会消耗实际带宽流量。100个节点 × 5MB 测速文件 = 最多消耗 500MB 流量。慢速节点消耗较少，但快速节点会下载完整文件。
